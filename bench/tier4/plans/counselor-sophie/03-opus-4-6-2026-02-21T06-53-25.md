

# Counselor Dashboard Implementation Plan

## Overview

Add a counselor dashboard at `/counselor` that displays all linked students' progress in a filterable, searchable table. The data flows through the `counselor_student` linking table to access each student's profile, academics, saved colleges, timeline, and activity.

## Database Relationship Chain

```
auth.users → profiles → counselor_student → students → [saved_colleges, timeline_items, etc.]
```

---

## 1. Database: Add Supabase View + RLS Policy

We need a database function or view to efficiently aggregate student data for counselors. Create a migration or run this SQL in Supabase SQL Editor:

```sql
-- Function to get counselor's students with aggregated progress
CREATE OR REPLACE FUNCTION get_counselor_students(p_counselor_profile_id uuid)
RETURNS TABLE (
  student_id uuid,
  first_name text,
  last_name text,
  email text,
  grade_level int,
  gpa numeric,
  weighted_gpa numeric,
  saved_colleges_count bigint,
  timeline_total bigint,
  timeline_completed bigint,
  last_active_at timestamptz
)
LANGUAGE sql
SECURITY DEFINER
STABLE
AS $$
  SELECT
    s.id AS student_id,
    p.first_name,
    p.last_name,
    p.email,
    s.grade_level,
    s.gpa,
    s.weighted_gpa,
    COALESCE(sc.cnt, 0) AS saved_colleges_count,
    COALESCE(ti.total, 0) AS timeline_total,
    COALESCE(ti.completed, 0) AS timeline_completed,
    GREATEST(s.updated_at, p.updated_at) AS last_active_at
  FROM counselor_student cs
  JOIN students s ON s.id = cs.student_id
  JOIN profiles p ON p.id = s.profile_id
  LEFT JOIN LATERAL (
    SELECT COUNT(*) AS cnt
    FROM saved_colleges sc2
    WHERE sc2.student_id = s.id
  ) sc ON true
  LEFT JOIN LATERAL (
    SELECT
      COUNT(*) AS total,
      COUNT(*) FILTER (WHERE ti2.completed = true) AS completed
    FROM timeline_items ti2
    WHERE ti2.student_id = s.id
  ) ti ON true
  WHERE cs.counselor_id = p_counselor_profile_id;
$$;
```

---

## 2. Zod Schemas — `lib/schemas.ts`

Add the counselor student data schema and request schema:

```typescript
// lib/schemas.ts — ADD these at the end of the file

// ============ COUNSELOR DASHBOARD ============

export const CounselorStudentSchema = z.object({
  student_id: z.string().uuid(),
  first_name: z.string().nullable(),
  last_name: z.string().nullable(),
  email: z.string().nullable(),
  grade_level: z.number().nullable(),
  gpa: z.number().nullable(),
  weighted_gpa: z.number().nullable(),
  saved_colleges_count: z.number(),
  timeline_total: z.number(),
  timeline_completed: z.number(),
  last_active_at: z.string().nullable(),
})

export type CounselorStudent = z.infer<typeof CounselorStudentSchema>

export const CounselorStudentsRequestSchema = z.object({
  counselor_profile_id: z.string().uuid(),
})
```

---

## 3. Database Operations — `lib/db.ts`

Add the function to fetch counselor students:

```typescript
// lib/db.ts — ADD this function

import type { CounselorStudent } from './schemas'

// ============ COUNSELOR DASHBOARD ============

export async function getCounselorStudents(
  supabase: ReturnType<typeof createClient>,
  counselorProfileId: string
): Promise<CounselorStudent[]> {
  const { data, error } = await supabase.rpc('get_counselor_students', {
    p_counselor_profile_id: counselorProfileId,
  })

  if (error) {
    console.error('Error fetching counselor students:', error)
    throw new Error(`Failed to fetch counselor students: ${error.message}`)
  }

  return (data ?? []) as CounselorStudent[]
}
```

---

## 4. API Route — `app/api/counselor-students/route.ts`

**Create new file:**

```typescript
// app/api/counselor-students/route.ts

import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'
import { getCounselorStudents } from '@/lib/db'

export async function GET(request: NextRequest) {
  try {
    const supabase = await createClient()

    // Verify authenticated user
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser()

    if (authError || !user) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    // Get the counselor's profile to find their profile_id
    const { data: profile, error: profileError } = await supabase
      .from('profiles')
      .select('id, role')
      .eq('user_id', user.id)
      .single()

    if (profileError || !profile) {
      return NextResponse.json({ error: 'Profile not found' }, { status: 404 })
    }

    if (profile.role !== 'counselor') {
      return NextResponse.json({ error: 'Forbidden: counselor role required' }, { status: 403 })
    }

    const students = await getCounselorStudents(supabase, profile.id)

    return NextResponse.json({ students })
  } catch (error) {
    console.error('Counselor students API error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

---

## 5. TanStack Query Hook — `hooks/useCounselorDashboard.ts`

**Create new file:**

```typescript
// hooks/useCounselorDashboard.ts

import { useQuery } from '@tanstack/react-query'
import type { CounselorStudent } from '@/lib/schemas'

async function fetchCounselorStudents(): Promise<CounselorStudent[]> {
  const res = await fetch('/api/counselor-students')
  if (!res.ok) {
    const body = await res.json().catch(() => ({}))
    throw new Error(body.error || 'Failed to fetch counselor students')
  }
  const data = await res.json()
  return data.students
}

export function useCounselorStudents() {
  return useQuery<CounselorStudent[]>({
    queryKey: ['counselor-students'],
    queryFn: fetchCounselorStudents,
    staleTime: 5 * 60 * 1000, // 5 minutes (matches QueryProvider defaults)
  })
}
```

---

## 6. Zustand Store — `store/index.ts`

Add counselor dashboard UI state selectors:

```typescript
// store/index.ts — ADD to the store interface and create

// In the store state interface, add:
interface AppState {
  // ... existing fields ...

  // Counselor Dashboard
  counselorSearchQuery: string
  counselorGradeFilter: number | null
  counselorSortField: 'name' | 'gpa' | 'colleges' | 'timeline' | 'lastActive'
  counselorSortDirection: 'asc' | 'desc'
  setCounselorSearchQuery: (query: string) => void
  setCounselorGradeFilter: (grade: number | null) => void
  setCounselorSort: (field: 'name' | 'gpa' | 'colleges' | 'timeline' | 'lastActive') => void
}

// In the create() block, add:
counselorSearchQuery: '',
counselorGradeFilter: null,
counselorSortField: 'name' as const,
counselorSortDirection: 'asc' as const,
setCounselorSearchQuery: (query) => set({ counselorSearchQuery: query }),
setCounselorGradeFilter: (grade) => set({ counselorGradeFilter: grade }),
setCounselorSort: (field) =>
  set((state) => ({
    counselorSortField: field,
    counselorSortDirection:
      state.counselorSortField === field && state.counselorSortDirection === 'asc' ? 'desc' : 'asc',
  })),

// Add granular selectors at the bottom:
export const useCounselorSearchQuery = () => useStore((s) => s.counselorSearchQuery)
export const useSetCounselorSearchQuery = () => useStore((s) => s.setCounselorSearchQuery)
export const useCounselorGradeFilter = () => useStore((s) => s.counselorGradeFilter)
export const useSetCounselorGradeFilter = () => useStore((s) => s.setCounselorGradeFilter)
export const useCounselorSortField = () => useStore((s) => s.counselorSortField)
export const useCounselorSortDirection = () => useStore((s) => s.counselorSortDirection)
export const useSetCounselorSort = () => useStore((s) => s.setCounselorSort)
```

---

## 7. Student Row Component — `components/counselor/StudentRow.tsx`

**Create new file:**

```typescript
// components/counselor/StudentRow.tsx

'use client'

import React from 'react'
import { cn } from '@/lib/utils'
import type { CounselorStudent } from '@/lib/schemas'
import { Badge } from '@/components/ui/badge'
import { GraduationCap, School, Clock } from 'lucide-react'

interface StudentRowProps {
  student: CounselorStudent
}

function formatLastActive(dateStr: string | null): string {
  if (!dateStr) return 'Never'
  const date = new Date(dateStr)
  const now = new Date()
  const diffMs = now.getTime() - date.getTime()
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))

  if (diffDays === 0) return 'Today'
  if (diffDays === 1) return 'Yesterday'
  if (diffDays < 7) return `${diffDays} days ago`
  if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
}

function getActivityColor(dateStr: string | null): string {
  if (!dateStr) return 'text-red-500'
  const diffDays = Math.floor((Date.now() - new Date(dateStr).getTime()) / (1000 * 60 * 60 * 24))
  if (diffDays <= 3) return 'text-green-600'
  if (diffDays <= 7) return 'text-yellow-600'
  if (diffDays <= 14) return 'text-orange-500'
  return 'text-red-500'
}

function getTimelinePercentage(completed: number, total: number): number {
  if (total === 0) return 0
  return Math.round((completed / total) * 100)
}

function getTimelineColor(pct: number): string {
  if (pct >= 75) return 'bg-green-500'
  if (pct >= 50) return 'bg-yellow-500'
  if (pct >= 25) return 'bg-orange-500'
  return 'bg-red-500'
}

function getGradeLabel(grade: number | null): string {
  if (grade === null) return '—'
  const labels: Record<number, string> = { 9: 'Freshman', 10: 'Sophomore', 11: 'Junior', 12: 'Senior' }
  return labels[grade] ?? `Grade ${grade}`
}

const StudentRow = React.memo(function StudentRow({ student }: StudentRowProps) {
  const fullName = [student.first_name, student.last_name].filter(Boolean).join(' ') || 'Unnamed Student'
  const timelinePct = getTimelinePercentage(student.timeline_completed, student.timeline_total)

  return (
    <tr className="border-b border-gray-100 hover:bg-gray-50/50 transition-colors">
      {/* Name + Email */}
      <td className="px-4 py-3">
        <div className="flex flex-col">
          <span className="font-medium text-gray-900">{fullName}</span>
          {student.email && <span className="text-sm text-gray-500">{student.email}</span>}
        </div>
      </td>

      {/* Grade */}
      <td className="px-4 py-3">
        <Badge variant="outline" className="text-xs">
          <GraduationCap className="mr-1 h-3 w-3" />
          {getGradeLabel(student.grade_level)}
        </Badge>
      </td>

      {/* GPA */}
      <td className="px-4 py-3 text-center">
        <div className="flex flex-col items-center">
          <span className="font-semibold text-gray-900">{student.gpa?.toFixed(2) ?? '—'}</span>
          {student.weighted_gpa && (
            <span className="text-xs text-gray-500">W: {student.weighted_gpa.toFixed(2)}</span>
          )}
        </div>
      </td>

      {/* Saved Colleges */}
      <td className="px-4 py-3 text-center">
        <div className="flex items-center justify-center gap-1">
          <School className="h-4 w-4 text-gray-400" />
          <span className="font-medium">{student.saved_colleges_count}</span>
        </div>
      </td>

      {/* Timeline Progress */}
      <td className="px-4 py-3">
        <div className="flex flex-col items-center gap-1">
          <div className="w-full max-w-[120px] bg-gray-200 rounded-full h-2">
            <div
              className={cn('h-2 rounded-full transition-all', getTimelineColor(timelinePct))}
              style={{ width: `${timelinePct}%` }}
            />
          </div>
          <span className="text-xs text-gray-500">
            {student.timeline_completed}/{student.timeline_total} ({timelinePct}%)
          </span>
        </div>
      </td>

      {/* Last Active */}
      <td className="px-4 py-3 text-center">
        <div className={cn('flex items-center justify-center gap-1 text-sm', getActivityColor(student.last_active_at))}>
          <Clock className="h-3 w-3" />
          {formatLastActive(student.last_active_at)}
        </div>
      </td>
    </tr>
  )
})

export default StudentRow
```

---

## 8. Students Table Component — `components/counselor/StudentsTable.tsx`

**Create new file:**

```typescript
// components/counselor/StudentsTable.tsx

'use client'

import React from 'react'
import { cn } from '@/lib/utils'
import type { CounselorStudent } from '@/lib/schemas'
import StudentRow from './StudentRow'
import { ArrowUpDown, ArrowUp, ArrowDown } from 'lucide-react'
import {
  useCounselorSortField,
  useCounselorSortDirection,
  useSetCounselorSort,
} from '@/store'

interface StudentsTableProps {
  students: CounselorStudent[]
}

type SortField = 'name' | 'gpa' | 'colleges' | 'timeline' | 'lastActive'

const columns: { key: SortField; label: string; className?: string }[] = [
  { key: 'name', label: 'Student' },
  { key: 'name', label: 'Grade' }, // Grade column doesn't sort by name; we'll handle below
  { key: 'gpa', label: 'GPA', className: 'text-center' },
  { key: 'colleges', label: 'Colleges', className: 'text-center' },
  { key: 'timeline', label: 'Timeline', className: 'text-center' },
  { key: 'lastActive', label: 'Last Active', className: 'text-center' },
]

// Actual sortable column definitions
const sortableColumns: { key: SortField; label: string; className?: string }[] = [
  { key: 'name', label: 'Student' },
  { key: 'gpa', label: 'GPA', className: 'text-center' },
  { key: 'colleges', label: 'Colleges', className: 'text-center' },
  { key: 'timeline', label: 'Timeline', className: 'text-center' },
  { key: 'lastActive', label: 'Last Active', className: 'text-center' },
]

function SortIcon({ field, currentField, direction }: { field: SortField; currentField: SortField; direction: 'asc' | 'desc' }) {
  if (field !== currentField) return <ArrowUpDown className="h-3 w-3 opacity-40" />
  return direction === 'asc' ? <ArrowUp className="h-3 w-3" /> : <ArrowDown className="h-3 w-3" />
}

export default function StudentsTable({ students }: StudentsTableProps) {
  const sortField = useCounselorSortField()
  const sortDirection = useCounselorSortDirection()
  const setSort = useSetCounselorSort()

  const sortedStudents = React.useMemo(() => {
    const sorted = [...students].sort((a, b) => {
      let cmp = 0
      switch (sortField) {
        case 'name': {
          const nameA = `${a.first_name ?? ''} ${a.last_name ?? ''}`.toLowerCase()
          const nameB = `${b.first_name ?? ''} ${b.last_name ?? ''}`.toLowerCase()
          cmp = nameA.localeCompare(nameB)
          break
        }
        case 'gpa':
          cmp = (a.gpa ?? 0) - (b.gpa ?? 0)
          break
        case 'colleges':
          cmp = a.saved_colleges_count - b.saved_colleges_count
          break
        case 'timeline': {
          const pctA = a.timeline_total > 0 ? a.timeline_completed / a.timeline_total : 0
          const pctB = b.timeline_total > 0 ? b.timeline_completed / b.timeline_total : 0
          cmp = pctA - pctB
          break
        }
        case 'lastActive': {
          const dateA = a.last_active_at ? new Date(a.last_active_at).getTime() : 0
          const dateB = b.last_active_at ? new Date(b.last_active_at).getTime() : 0
          cmp = dateA - dateB
          break
        }
      }
      return sortDirection === 'asc' ? cmp : -cmp
    })
    return sorted
  }, [students, sortField, sortDirection])

  if (students.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-16 text-gray-500">
        <p className="text-lg font-medium">No students found</p>
        <p className="text-sm mt-1">Try adjusting your search or filters.</p>
      </div>
    )
  }

  return (
    <div className="overflow-x-auto rounded-lg border border-gray-200">
      <table className="w-full text-sm">
        <thead>
          <tr className="bg-gray-50 border-b border-gray-200">
            {/* Student Name - sortable */}
            <th
              className="px-4 py-3 text-left font-semibold text-gray-700 cursor-pointer hover:bg-gray-100 transition-colors"
              onClick={() => setSort('name')}
            >
              <div className="flex items-center gap-1">
                Student
                <SortIcon field="name" currentField={sortField} direction={sortDirection} />
              </div>
            </th>

            {/* Grade - not sortable from header (filtered instead) */}
            <th className="px-4 py-3 text-left font-semibold text-gray-700">Grade</th>

            {/* GPA - sortable */}
            <th
              className="px-4 py-3 text-center font-semibold text-gray-700 cursor-pointer hover:bg-gray-100 transition-colors"
              onClick={() => setSort('gpa')}
            >
              <div className="flex items-center justify-center gap-1">
                GPA
                <SortIcon field="gpa" currentField={sortField} direction={sortDirection} />
              </div>
            </th>

            {/* Colleges - sortable */}
            <th
              className="px-4 py-3 text-center font-semibold text-gray-700 cursor-pointer hover:bg-gray-100 transition-colors"
              onClick={() => setSort('colleges')}
            >
              <div className="flex items-center justify-center gap-1">
                Colleges
                <SortIcon field="colleges" currentField={sortField} direction={sortDirection} />
              </div>
            </th>

            {/* Timeline - sortable */}
            <th
              className="px-4 py-3 text-center font-semibold text-gray-700 cursor-pointer hover:bg-gray-100 transition-colors"
              onClick={() => setSort('timeline')}
            >
              <div className="flex items-center justify-center gap-1">
                Timeline
                <SortIcon field="timeline" currentField={sortField} direction={sortDirection} />
              </div>
            </th>

            {/* Last Active - sortable */}
            <th
              className="px-4 py-3 text-center font-semibold text-gray-700 cursor-pointer hover:bg-gray-100 transition-colors"
              onClick={() => setSort('lastActive')}
            >
              <div className="flex items-center justify-center gap-1">
                Last Active
                <SortIcon field="lastActive" currentField={sortField} direction={sortDirection} />
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          {sortedStudents.map((student) => (
            <StudentRow key={student.student_id} student={student} />
          ))}
        </tbody>
      </table>
    </div>
  )
}
```

---

## 9. Filter Bar Component — `components/counselor/CounselorFilters.tsx`

**Create new file:**

```typescript
// components/counselor/CounselorFilters.tsx

'use client'

import React from 'react'
import { Input } from '@/components/ui/input'
import { Search, X } from 'lucide-react'
import { cn } from '@/lib/utils'
import {
  useCounselorSearchQuery,
  useSetCounselorSearchQuery,
  useCounselorGradeFilter,
  useSetCounselorGradeFilter,
} from '@/store'

const GRADE_OPTIONS = [
  { value: null, label: 'All Grades' },
  { value: 9, label: 'Freshman (9)' },
  { value: 10, label: 'Sophomore (10)' },
  { value: 11, label: 'Junior (11)' },
  { value: 12, label: 'Senior (12)' },
] as const

export default function CounselorFilters() {
  const searchQuery = useCounselorSearchQuery()
  const setSearchQuery = useSetCounselorSearchQuery()
  const gradeFilter = useCounselorGradeFilter()
  const setGradeFilter = useSetCounselorGradeFilter()

  return (
    <div className="flex flex-col sm:flex-row gap-3 items-start sm:items-center">
      {/* Search Input */}
      <div className="relative w-full sm:w-80">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
        <Input
          type="text"
          placeholder="Search by student name..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="pl-9 pr-8"
        />
        {searchQuery && (
          <button
            onClick={() => setSearchQuery('')}
            className="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-full hover:bg-gray-100 transition-colors"
          >
            <X className="h-3 w-3 text-gray-400" />
          </button>
        )}
      </div>

      {/* Grade Filter Tabs */}
      <div className="flex gap-1 flex-wrap">
        {GRADE_OPTIONS.map((option) => (
          <button
            key={option.label}
            onClick={() => setGradeFilter(option.value)}
            className={cn(
              'px-3 py-1.5 rounded-md text-sm font-medium transition-colors',
              gradeFilter === option.value
                ? 'bg-blue-600 text-white shadow-sm'
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            )}
          >
            {option.label}
          </button>
        ))}
      </div>
    </div>
  )
}
```

---

## 10. Summary Stats Component — `components/counselor/CounselorStats.tsx`

**Create new file:**

```typescript
// components/counselor/CounselorStats.tsx

'use client'

import React from 'react'
import type { CounselorStudent } from '@/lib/schemas'
import { Users, GraduationCap, School, CheckCircle } from 'lucide-react'

interface CounselorStatsProps {
  students: CounselorStudent[]
}

export default function CounselorStats({ students }: CounselorStatsProps) {
  const stats = React.useMemo(() => {
    const total = students.length
    const avgGpa =
      students.filter((s) => s.gpa !== null).reduce((sum, s) => sum + (s.gpa ?? 0), 0) /
        (students.filter((s) => s.gpa !== null).length || 1)
    const totalColleges = students.reduce((sum, s) => sum + s.saved_colleges_count, 0)
    const avgTimeline =
      students.length > 0
        ? students.reduce((sum, s) => {
            return sum + (s.timeline_total > 0 ? (s.timeline_completed / s.timeline_total) * 100 : 0)
          }, 0) / students.length
        : 0

    return { total, avgGpa, totalColleges, avgTimeline }
  }, [students])

  const cards = [
    {
      icon: Users,
      label: 'Total Students',
      value: stats.total.toString(),
      color: 'text-blue-600 bg-blue-50',
    },
    {
      icon: GraduationCap,
      label: 'Average GPA',
      value: stats.avgGpa.toFixed(2),
      color: 'text-green-600 bg-green-50',
    },
    {
      icon: School,
      label: 'Total Saved Colleges',
      value: stats.totalColleges.toString(),
      color: 'text-purple-600 bg-purple-50',
    },
    {
      icon: CheckCircle,
      label: 'Avg Timeline Completion',
      value: `${Math.round(stats.avgTimeline)}%`,
      color: 'text-orange-600 bg-orange-50',
    },
  ]

  return (
    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
      {cards.map((card) => (
        <div key={card.label} className="bg-white rounded-lg border border-gray-200 p-4">
          <div className="flex items-center gap-3">
            <div className={`p-2 rounded-lg ${card.color}`}>
              <card.icon className="h-5 w-5" />
            </div>
            <div>
              <p className="text-2xl font-bold text-gray-900">{card.value}</p>
              <p className="text-xs text-gray-500">{card.label}</p>
            </div>
          </div>
        </div>
      ))}
    </div>
  )
}
```

---

## 11. Counselor Dashboard Page — `app/(dashboard)/counselor/page.tsx`

**Create new file:**

```typescript
// app/(dashboard)/counselor/page.tsx

'use client'

import React, { useMemo } from 'react'
import { useCounselorStudents } from '@/hooks/useCounselorDashboard'
import CounselorFilters from '@/components/counselor/CounselorFilters'
import CounselorStats from '@/components/counselor/CounselorStats'
import StudentsTable from '@/components/counselor/StudentsTable'
import { useCounselorSearchQuery, useCounselorGradeFilter } from '@/store'
import { Loader2, AlertCircle, Users } from 'lucide-react'

export default function CounselorDashboardPage() {
  const { data: students, isLoading, error } = useCounselorStudents()
  const searchQuery = useCounselorSearchQuery()
  const gradeFilter = useCounselorGradeFilter()

  // Pre-compute filtered list (don't filter inline in render)
  const filteredStudents = useMemo(() => {
    if (!students) return []

    let result = students

    // Filter by grade level
    if (gradeFilter !== null) {
      result = result.filter((s) => s.grade_level === gradeFilter)
    }

    // Filter by search query (name)
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase().trim()
      result = result.filter((s) => {
        const fullName = `${s.first_name ?? ''} ${s.last_name ?? ''}`.toLowerCase()
        return fullName.includes(query)
      })
    }

    return result
  }, [students, searchQuery, gradeFilter])

  // ============ LOADING STATE ============
  if (isLoading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="flex flex-col items-center gap-3">
          <Loader2 className="h-8 w-8 animate-spin text-blue-600" />
          <p className="text-sm text-gray-500">Loading student data...</p>
        </div>
      </div>
    )
  }

  // ============ ERROR STATE ============
  if (error) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
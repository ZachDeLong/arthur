

# Implementation Plan: Email Notification on College Save

## Overview

When a student saves a new college to their `saved_colleges` table, send a confirmation email via Resend with the college name, tier rating, and a link back to the colleges page. This requires a new API route, a React Email template, integration into the existing save mutation, and a database table for email preferences.

---

## 1. Install Dependencies

```bash
npm install resend @react-email/components
```

---

## 2. Environment Variables

Add to `.env.local` and Vercel dashboard:

```bash
RESEND_API_KEY=re_xxxxxxxxxxxx          # From Resend dashboard
RESEND_FROM_EMAIL=notifications@counselorsophie.com  # Verified domain in Resend
```

---

## 3. Database Changes

### 3a. Create `email_preferences` table

Run in Supabase SQL Editor:

```sql
-- Email preferences table
CREATE TABLE public.email_preferences (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id uuid NOT NULL REFERENCES public.students(id) ON DELETE CASCADE,
  college_saved_email boolean NOT NULL DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  UNIQUE(student_id)
);

-- RLS
ALTER TABLE public.email_preferences ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own email preferences"
  ON public.email_preferences FOR SELECT
  USING (has_student_access(student_id));

CREATE POLICY "Users can update own email preferences"
  ON public.email_preferences FOR UPDATE
  USING (has_student_access(student_id));

CREATE POLICY "Users can insert own email preferences"
  ON public.email_preferences FOR INSERT
  WITH CHECK (has_student_access(student_id));

-- Service role can read for sending emails
CREATE POLICY "Service role full access"
  ON public.email_preferences FOR ALL
  USING ((select auth.role()) = 'service_role');

-- Updated_at trigger
CREATE TRIGGER update_email_preferences_updated_at
  BEFORE UPDATE ON public.email_preferences
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 3b. Create `email_log` table (for tracking/debugging)

```sql
CREATE TABLE public.email_log (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  student_id uuid NOT NULL REFERENCES public.students(id) ON DELETE CASCADE,
  email_type text NOT NULL,
  recipient_email text NOT NULL,
  subject text NOT NULL,
  resend_id text,
  status text NOT NULL DEFAULT 'sent',
  error_message text,
  metadata jsonb DEFAULT '{}',
  created_at timestamptz DEFAULT now()
);

ALTER TABLE public.email_log ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Service role only"
  ON public.email_log FOR ALL
  USING ((select auth.role()) = 'service_role');
```

---

## 4. Zod Schemas

### Modify `lib/schemas.ts`

Add the following schemas at the bottom of the file:

```typescript
// ============ EMAIL NOTIFICATION SCHEMAS ============

export const CollegeSavedEmailRequestSchema = z.object({
  studentId: z.string().uuid(),
  collegeName: z.string().min(1),
  collegeTier: z.enum(['High Reach', 'Reach', 'Target', 'Safety']).nullable(),
  collegeId: z.string().uuid().optional(),
  unitId: z.string().optional(), // College Scorecard unit ID for linking
})

export type CollegeSavedEmailRequest = z.infer<typeof CollegeSavedEmailRequestSchema>

export const EmailPreferencesSchema = z.object({
  college_saved_email: z.boolean().default(true),
})

export type EmailPreferences = z.infer<typeof EmailPreferencesSchema>
```

---

## 5. Resend Client

### Create `lib/resend.ts`

```typescript
import { Resend } from 'resend'

if (!process.env.RESEND_API_KEY) {
  console.warn('RESEND_API_KEY is not set â€” emails will not be sent')
}

export const resend = new Resend(process.env.RESEND_API_KEY)

export const FROM_EMAIL = process.env.RESEND_FROM_EMAIL || 'notifications@counselorsophie.com'
```

---

## 6. Email Template

### Create `lib/email-templates/college-saved.tsx`

```tsx
import {
  Body,
  Container,
  Head,
  Heading,
  Hr,
  Html,
  Link,
  Preview,
  Section,
  Text,
} from '@react-email/components'

interface CollegeSavedEmailProps {
  studentName: string
  collegeName: string
  collegeTier: string | null
  collegesPageUrl: string
}

const tierColors: Record<string, string> = {
  'High Reach': '#ef4444',
  Reach: '#f97316',
  Target: '#22c55e',
  Safety: '#3b82f6',
}

const tierDescriptions: Record<string, string> = {
  'High Reach': 'This is a highly competitive school for your profile â€” dream big!',
  Reach: 'This school is a stretch, but within possibility with a strong application.',
  Target: 'Your profile aligns well with this school â€” a solid choice.',
  Safety: 'You have a strong chance of admission here â€” great safety option.',
}

export function CollegeSavedEmail({ studentName, collegeName, collegeTier, collegesPageUrl }: CollegeSavedEmailProps) {
  const tierColor = collegeTier ? tierColors[collegeTier] || '#6b7280' : '#6b7280'
  const tierDescription = collegeTier ? tierDescriptions[collegeTier] || '' : ''

  return (
    <Html>
      <Head />
      <Preview>
        {collegeName} added to your college list{collegeTier ? ` as a ${collegeTier}` : ''}
      </Preview>
      <Body style={bodyStyle}>
        <Container style={containerStyle}>
          <Heading style={headingStyle}>College Added! ðŸŽ“</Heading>

          <Text style={greetingStyle}>Hi {studentName},</Text>

          <Text style={textStyle}>
            You've successfully added <strong>{collegeName}</strong> to your college list.
          </Text>

          {collegeTier && (
            <Section style={tierSectionStyle}>
              <Text style={{ ...tierBadgeStyle, backgroundColor: tierColor }}>{collegeTier}</Text>
              <Text style={tierDescriptionStyle}>{tierDescription}</Text>
            </Section>
          )}

          <Section style={ctaSectionStyle}>
            <Link href={collegesPageUrl} style={buttonStyle}>
              View My College List
            </Link>
          </Section>

          <Hr style={hrStyle} />

          <Text style={footerStyle}>
            You're receiving this because you have college save notifications enabled. You can turn this off in your{' '}
            <Link href={`${collegesPageUrl.replace('/colleges', '/profile')}`} style={linkStyle}>
              profile settings
            </Link>
            .
          </Text>

          <Text style={footerStyle}>â€” CounselorSophie</Text>
        </Container>
      </Body>
    </Html>
  )
}

// Styles
const bodyStyle: React.CSSProperties = {
  backgroundColor: '#f6f9fc',
  fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
}

const containerStyle: React.CSSProperties = {
  backgroundColor: '#ffffff',
  margin: '0 auto',
  padding: '40px 32px',
  maxWidth: '560px',
  borderRadius: '8px',
  border: '1px solid #e5e7eb',
}

const headingStyle: React.CSSProperties = {
  fontSize: '24px',
  fontWeight: '700',
  color: '#111827',
  textAlign: 'center' as const,
  margin: '0 0 24px',
}

const greetingStyle: React.CSSProperties = {
  fontSize: '16px',
  color: '#374151',
  margin: '0 0 8px',
}

const textStyle: React.CSSProperties = {
  fontSize: '16px',
  lineHeight: '24px',
  color: '#374151',
  margin: '0 0 16px',
}

const tierSectionStyle: React.CSSProperties = {
  backgroundColor: '#f9fafb',
  borderRadius: '8px',
  padding: '20px',
  margin: '16px 0 24px',
  textAlign: 'center' as const,
}

const tierBadgeStyle: React.CSSProperties = {
  display: 'inline-block',
  color: '#ffffff',
  fontSize: '14px',
  fontWeight: '600',
  padding: '6px 16px',
  borderRadius: '20px',
  margin: '0 0 8px',
}

const tierDescriptionStyle: React.CSSProperties = {
  fontSize: '14px',
  color: '#6b7280',
  margin: '8px 0 0',
}

const ctaSectionStyle: React.CSSProperties = {
  textAlign: 'center' as const,
  margin: '24px 0',
}

const buttonStyle: React.CSSProperties = {
  backgroundColor: '#4f46e5',
  color: '#ffffff',
  fontSize: '16px',
  fontWeight: '600',
  textDecoration: 'none',
  padding: '12px 32px',
  borderRadius: '6px',
  display: 'inline-block',
}

const hrStyle: React.CSSProperties = {
  borderColor: '#e5e7eb',
  margin: '32px 0 16px',
}

const footerStyle: React.CSSProperties = {
  fontSize: '12px',
  color: '#9ca3af',
  lineHeight: '20px',
}

const linkStyle: React.CSSProperties = {
  color: '#4f46e5',
  textDecoration: 'underline',
}

export default CollegeSavedEmail
```

---

## 7. API Route â€” Send College Saved Email

### Create `app/api/email/college-saved/route.ts`

```typescript
import { NextRequest, NextResponse } from 'next/server'

import { CollegeSavedEmail } from '@/lib/email-templates/college-saved'
import { resend, FROM_EMAIL } from '@/lib/resend'
import { CollegeSavedEmailRequestSchema, parseRequestBody } from '@/lib/schemas'
import { createServiceRoleClient } from '@/lib/supabase/server'

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    const parsed = parseRequestBody(CollegeSavedEmailRequestSchema, body)
    if (!parsed.success) return parsed.response
    const { studentId, collegeName, collegeTier, unitId } = parsed.data

    const supabase = createServiceRoleClient()

    // 1. Check email preferences
    const { data: preferences } = await supabase
      .from('email_preferences')
      .select('college_saved_email')
      .eq('student_id', studentId)
      .single()

    // If preferences exist and college_saved_email is explicitly false, skip
    if (preferences && preferences.college_saved_email === false) {
      return NextResponse.json({ sent: false, reason: 'notifications_disabled' })
    }

    // 2. Get student info + linked profile email
    const { data: student, error: studentError } = await supabase
      .from('students')
      .select('id, first_name, last_name, profile_id')
      .eq('id', studentId)
      .single()

    if (studentError || !student) {
      console.error('Failed to fetch student:', studentError)
      return NextResponse.json({ sent: false, reason: 'student_not_found' }, { status: 404 })
    }

    // 3. Get the user's email from profiles â†’ auth.users
    const { data: profile, error: profileError } = await supabase
      .from('profiles')
      .select('user_id, first_name, last_name')
      .eq('id', student.profile_id)
      .single()

    if (profileError || !profile) {
      console.error('Failed to fetch profile:', profileError)
      return NextResponse.json({ sent: false, reason: 'profile_not_found' }, { status: 404 })
    }

    // Get email from auth.users via service role
    const { data: authUser, error: authError } = await supabase.auth.admin.getUserById(profile.user_id)

    if (authError || !authUser?.user?.email) {
      console.error('Failed to fetch auth user:', authError)
      return NextResponse.json({ sent: false, reason: 'email_not_found' }, { status: 404 })
    }

    const recipientEmail = authUser.user.email
    const studentName = student.first_name || profile.first_name || 'Student'
    const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'
    const collegesPageUrl = `${appUrl}/colleges`

    // 4. Send email via Resend
    const subject = `${collegeName} added to your college list`

    const { data: emailResult, error: emailError } = await resend.emails.send({
      from: `CounselorSophie <${FROM_EMAIL}>`,
      to: [recipientEmail],
      subject,
      react: CollegeSavedEmail({
        studentName,
        collegeName,
        collegeTier: collegeTier || null,
        collegesPageUrl,
      }),
    })

    if (emailError) {
      console.error('Resend email error:', emailError)

      // Log failed attempt
      await supabase.from('email_log').insert({
        student_id: studentId,
        email_type: 'college_saved',
        recipient_email: recipientEmail,
        subject,
        status: 'failed',
        error_message: emailError.message || JSON.stringify(emailError),
        metadata: { college_name: collegeName, college_tier: collegeTier },
      })

      return NextResponse.json({ sent: false, reason: 'send_failed' }, { status: 500 })
    }

    // 5. Log successful send
    await supabase.from('email_log').insert({
      student_id: studentId,
      email_type: 'college_saved',
      recipient_email: recipientEmail,
      subject,
      resend_id: emailResult?.id || null,
      status: 'sent',
      metadata: { college_name: collegeName, college_tier: collegeTier },
    })

    return NextResponse.json({ sent: true, resendId: emailResult?.id })
  } catch (error) {
    console.error('College saved email error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

---

## 8. API Client Helper

### Modify `lib/api-client.ts`

Add at the bottom of the file:

```typescript
// ============ EMAIL NOTIFICATIONS ============

export async function sendCollegeSavedEmail(params: {
  studentId: string
  collegeName: string
  collegeTier: string | null
  collegeId?: string
  unitId?: string
}): Promise<{ sent: boolean; reason?: string }> {
  try {
    const res = await fetch('/api/email/college-saved', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        studentId: params.studentId,
        collegeName: params.collegeName,
        collegeTier: params.collegeTier,
        collegeId: params.collegeId,
        unitId: params.unitId,
      }),
    })

    if (!res.ok) {
      const data = await res.json().catch(() => ({}))
      console.warn('Email notification failed:', data)
      return { sent: false, reason: data.reason || 'request_failed' }
    }

    return await res.json()
  } catch (error) {
    // Email failures should never block the main flow
    console.warn('Email notification error:', error)
    return { sent: false, reason: 'network_error' }
  }
}
```

---

## 9. Integrate into College Save Mutation

### Modify `hooks/useColleges.ts`

Find the existing mutation that inserts into `saved_colleges` (likely named `useSaveCollege` or similar). Add the email call in `onSuccess`. The key principle: **email is fire-and-forget, never blocks the save**.

```typescript
import { sendCollegeSavedEmail } from '@/lib/api-client'

// Inside the existing useSaveCollege or useAddCollege hook:
// Find the useMutation that inserts into saved_colleges

// Example modification â€” adapt to match the exact existing mutation shape:

export function useSaveCollege(studentId: string | undefined) {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: async (college: {
      name: string
      tier?: string | null
      unit_id?: string
      // ... other existing fields
    }) => {
      const supabase = createClient()
      const { data, error } = await supabase
        .from('saved_colleges')
        .insert({
          student_id: studentId,
          college_name: college.name,
          tier: college.tier || null,
          unit_id: college.unit_id || null,
          // ... other existing fields preserved
        })
        .select()
        .single()

      if (error) throw error
      return data
    },
    onSuccess: (data, variables) => {
      // Existing cache invalidation â€” preserve as-is
      queryClient.invalidateQueries({ queryKey: ['saved-colleges', studentId] })

      // Fire-and-forget email notification
      if (studentId) {
        sendCollegeSavedEmail({
          studentId,
          collegeName: variables.name,
          collegeTier: variables.tier || null,
          collegeId: data?.id,
          unitId: variables.unit_id,
        }).catch(() => {
          // Silently ignore â€” email failures must never affect UX
        })
      }
    },
    // ... existing onError, etc.
  })
}
```

> **Important:** Do not change the mutation's return type or add `await` to the email call. The `.catch()` ensures it's truly fire-and-forget.

---

## 10. Email Preferences UI

### Create `components/profile/EmailPreferences.tsx`

```tsx
'use client'

import { useState, useEffect } from 'react'
import { Bell, BellOff, Loader2 } from 'lucide-react'

import { Switch } from '@/components/ui/switch'
import { Label } from '@/components/ui/label'
import { createClient } from '@/lib/supabase/client'
import { cn } from '@/lib/utils'

interface EmailPreferencesProps {
  studentId: string
}

export function EmailPreferences({ studentId }: EmailPreferencesProps) {
  const [collegeSavedEmail, setCollegeSavedEmail] = useState(true)
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)

  useEffect(() => {
    async function loadPreferences() {
      const supabase = createClient()
      const { data } = await supabase
        .from('email_preferences')
        .select('college_saved_email')
        .eq('student_id', studentId)
        .single()

      if (data) {
        setCollegeSavedEmail(data.college_saved_email)
      }
      // If no data, defaults to true (new user)
      setLoading(false)
    }

    if (studentId) {
      loadPreferences()
    }
  }, [studentId])

  async function handleToggle(checked: boolean) {
    setCollegeSavedEmail(checked)
    setSaving(true)

    const supabase = createClient()
    const { error } = await supabase
      .from('email_preferences')
      .upsert(
        {
          student_id: studentId,
          college_saved_email: checked,
          updated_at: new Date().toISOString(),
        },
        { onConflict: 'student_id' }
      )

    if (error) {
      console.error('Failed to save email preferences:', error)
      // Revert on failure
      setCollegeSavedEmail(!checked)
    }

    setSaving(false)
  }

  if (loading) {
    return (
      <div className="flex items-center gap-2 text-sm text-muted-foreground">
        <Loader2 className="h-4 w-4 animate-spin" />
        Loading email preferences...
      </div>
    )
  }

  return (
    <div className="space-y-4">
      <h3 className="text-sm font-semibold text-foreground">Email Notifications</h3>

      <div className="flex items-center justify-between rounded-lg border p-4">
        <div className="flex items-center gap-3">
          {collegeSavedEmail ? (
            <Bell className="h-5 w-5 text-indigo-500" />
          ) : (
            <BellOff className="h-5 w-5 text-muted-foreground" />
          )}
          <div>
            <Label htmlFor="college-saved-email" className="text-sm font-medium">
              College save confirmations
            </Label>
            <p className="text-xs text-muted-foreground">
              Receive an email each time you add a college to your list
            </p>
          </div>
        </div>

        <div className="flex items-center gap-2">
          {saving && <Loader2 className="h-3 w-3 animate-spin text-muted-foreground" />}
          <Switch
            id="college-saved-email"
            checked={collegeSavedEmail}
            onCheckedChange={handleToggle}
            disabled={saving}
          />
        </div>
      </div>
    </div>
  )
}
```

### Modify `app/(dashboard)/profile/page.tsx`

Add the `EmailPreferences` component inside the profile page. Find the appropriate section (likely after the "Information" section or as a new collapsible section):

```tsx
import { EmailPreferences } from '@/components/profile/EmailPreferences'

// Inside the profile page component, where studentId is available:
// Add as a new section, e.g., Section 6: Notification Preferences

// ============ NOTIFICATION PREFERENCES ============
{studentId && (
  <section className="rounded-lg border bg-card p-6">
    <EmailPreferences studentId={studentId} />
  </section>
)}
```

---

## 11. File Summary

| File | Action | Purpose |
|------|--------|---------|
| `lib/resend.ts` | **Create** | Resend client singleton |
| `lib/email-templates/college-saved.tsx` | **Create** | React Email template for college saved notification |
| `app/api/email/college-saved/route.ts` | **Create** | POST endpoint to send college saved email |
| `components/profile/EmailPreferences.tsx` | **Create** | Toggle UI for email notification preferences |
| `lib/schemas.ts` | **Modify** | Add `CollegeSavedEmailRequestSchema`, `EmailPreferencesSchema` |
| `lib/api-client.ts` | **Modify** | Add `sendCollegeSavedEmail()` helper |
| `hooks/useColleges.ts` | **Modify** | Fire email in `onSuccess` of save mutation |
| `app/(dashboard)/profile/page.tsx` | **Modify** | Add `EmailPreferences` component |
| SQL migration | **Run** | Create `email_preferences` and `email_log` tables |

---

## 12. Testing Plan

### Manual Testing Steps

1. **Happy path**: Save a new college â†’ check Resend dashboard for sent email â†’ verify email content
2. **Preferences off**: Toggle off notifications in profile â†’ save college â†’ confirm no email sent
3. **New user (no preferences row)**: First-time save â†’ should default to sending email
4. **Invalid student**: Call API with bad studentId â†’ confirm 404, no crash
5. **Resend down**: Temporarily use bad API key â†’ confirm college save still succeeds, email fails silently
6. **Email log**: Check `email_log` table for both successful and failed entries

### Build Verification

```bash
npx tsc --noEmit        # Ensure no type errors
npm run build           # Ensure production build succeeds
npm run lint            # Check for new lint issues
```

---

## 13. Deployment Checklist

1. Add `RESEND_API_KEY` and `RESEND_FROM_EMAIL` to Vercel Environment Variables
2. Verify domain in Resend dashboard (for production sending)
3. Run SQL migrations in Supabase dashboard
4. Deploy to Vercel
5. Test with a real email address in staging
6. Monitor `email_log` table and Resend dashboard for delivery rates